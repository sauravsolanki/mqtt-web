<html>
<!-- <html lang="en"> -->

<head>
    <meta charset="UTF-8">
    <title>DeepEdge MQTT Server</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script type="text/javascript" language="JavaScript">

        var mqtt;
        var reconnectTimeout = 2000;
        var host = "";
        var port = 0;
        var clientID = "clientID_" + parseInt(Math.random() * 100);
        var test_topic = "test/deepedge";

        function onConnect(message) {
            console.log("connected");

            document.getElementById("status").innerHTML = "Connected Successfully";

            // subcribe to topic
            mqtt.subscribe(test_topic);

            // send the payload
            message = new Paho.MQTT.Message("Hello From DeepEdge");
            message.destinationName = test_topic;
            mqtt.send(message);

        }

        function onFailure(message) {
            var t ="connecting Attempted " + host + ":" + port + " Failed \n"
            console.log(t);
            console.log(message);
            document.getElementById("status").innerHTML = t + message.errorMessage;
            // setTimeout(MQTTConnect, reconnectTimeout);
        }



        function onConnectionLost(message) {
            console.log("connection Lost " + host + ":" + port + "Failed");
            console.log(message);
            document.getElementById("status").innerHTML = message.errorMessage;
        }


        function onMessageArrived(message) {
            out_msg = "Message Received " + message.payloadString + " <br> ";
            out_msg = out_msg + "Message Received topic " + message.destinationName;
            console.log(out_msg);

            // Show the recieved data in subscribed_data div
            const node = document.createElement("div");
            const textnode = document.createTextNode(out_msg);
            node.appendChild(textnode);

            document.getElementById("subscribed_data").appendChild(node);

            // document.getElementById("subscribed_data").innerHTML = out_msg;
        }


        function onConnected(reconn, url) {
            console.log("Connect in " + reconn);
            document.getElementById("status").innerHTML = reconn;

        }

        function sub_topics() {
            // TODO: if not connected, notify and return
            var stopic = document.forms["subs"]["subcribe_topic"].value;
            console.log("Subcribing to a topic" + stopic);
            mqtt.subscribe(stopic);

            // reset the subcribe data
            document.getElementById("subscribed_data").innerHTML = "";;


            return false
        }

        function send_message() {
            // TODO: if not connected, notify and return
            var msg = document.forms["pubs"]["message"].value;
            var topic = document.forms["pubs"]["publish_topic"].value;


            console.log("Sending Message: " + msg + "a topic" + topic);

            // publish the message  
            var temp_payload = new Paho.MQTT.Message(msg);
            temp_payload.destinationName = topic;
            mqtt.send(temp_payload);
        }

        function MQTTConnect(event) {

            // Fetch the hostname/IP address and port number from the form
            host = document.getElementById("hostname").value;
            port = Number(document.getElementById("port").value);
            clientID = "clientID_" + parseInt(Math.random() * 100);

            // host = document.forms["creds"]["hostname"].value;
            // port = Number(document.forms["creds"]["port"].value);

            console.log("connecting to " + host + ":" + port);

            // 
            mqtt = new Paho.MQTT.Client(host, port, clientID);
            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;
            mqtt.onConnected = onConnected;

            var options = {
                // useSSL: true,
                userName: 'deepedge',
                password:'Deepedge',
                timeout: 30000,
                cleanSession: true,
                onSuccess: onConnect,
                onFailure: onFailure
            };

            mqtt.connect(options);
            return false
        }


    </script>
</head>

<body>




    <form name="creds" action="javascript:MQTTConnect()">
        <label for="hostname">Server:</label><br>
        <input type="text" id="hostname" name="hostname" value="localhost"><br>

        <label for="port">Port:</label><br>
        <input type="integer" id="port" name="port" value=8081><br><br>

        <input type="submit" value="Submit">
    </form>


    <hr>
    <hr>

    <form name="pubs" action="javascript:send_message()">
        <label for="publish_topic">Publish Topic:</label><br>
        <input type="text" id="publish_topic" name="publish_topic" value="test/deepedge"><br>

        <label for="message">Message:</label><br>
        <input type="text" id="message" name="message" value="Hello DeepEdge"><br>

        <input type="submit" value="Publish">
    </form>

    <hr>
    <hr>

    <!-- subcription -->
    <form name="subs" action="javascript:sub_topics()">

        <label for="subcribe_topic">Subcribe Topic:</label><br>
        <input type="text" id="subcribe_topic" name="subcribe_topic" value="#"><br>

        <input type="submit" value="Subscribe">
    </form>

    <!-- status on application -->
    <div id="status"></div>


    <div id="subscribed_data">
        <div>Messgae 1</div>
    </div>

    <script>
        MQTTConnect();
    </script>


</body>

</html>